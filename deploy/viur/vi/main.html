<!doctype html>
<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="vi/public/css/style.css"/>
	<link rel="stylesheet" href="vi/public/htmleditor/htmleditor.min.css"/>
	<script src="vi/public/htmleditor/htmleditor.min.js"></script>
	<script>
		window.languagePluginUrl = "./pyodide/";
	</script>
	<script src="./pyodide/pyodide.js"></script>
</head>
<body>
<script>
	function loadFiles(files) {
		let promises = [];

		let baseURL = window.location.href;
		baseURL = baseURL.substr(0, baseURL.lastIndexOf('/')) + '/';

		for (var f in files) {
			promises.push(
					new Promise((resolve, reject) => {
						let file = files[f];
						let url = baseURL + file;

						fetch(url, {}).then((response) => {
							if (response.status === 200)
								return response.text().then((code) => {
									let path = (window.pyodide._pythonPath + file).split("/");
									let lookup = "";

									for (let i in path) {
										if (path[i] === "")
											continue;

										lookup += "/" + path[i];

										if (i == path.length - 1) {
											window.pyodide._module.FS.writeFile(lookup, code);
										} else {
											try {
												window.pyodide._module.FS.lookupPath(lookup);
											} catch {
												window.pyodide._module.FS.mkdir(lookup);
											}
										}
									}

									console.debug(`fetched ${file} from ${url}, saved to ${lookup}`);
									resolve();
								});
							else
								reject();
						});
					})
			);
		}

		return Promise.all(promises);
	}

	function loadJson() {
		let promises = [];
		promises.push(
				new Promise((resolve, reject) => {
					url = "/vi/s/files.json";
					fetch(url, {}).then((response) => {
						if (response.status === 200) {
							response.text().then((list) => {
								let files = JSON.parse(list)
								loadFiles(files).then(() => {
									resolve();
								})
							})
						} else {
							reject();
						}
					})
				}));
		return Promise.all(promises);
	}

	languagePluginLoader.then(() => {
		loadJson().then(() => {
			window.pyodide.loadedPackages["vi"] = "default channel";
			window.pyodide.loadedPackages["vi_plugins"] = "default channel";

			window.pyodide.runPython(
					'import importlib as _importlib\n' +
					'_importlib.invalidate_caches()\n'
			);

			window.pyodide.runPythonAsync("import vi\nimport vi_plugins\nvi.start()");
		});
	});
</script>
</body>
</html>
